<!DOCTYPE html>
<html>
<head>
    <title>Delivery Cost Parser</title>
    <!-- Load Jotform Custom Widget API -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <div id="main">
        <!-- Display parsed results -->
        <h3>Parsed Delivery Info</h3>
        <div id="parsedResult">
            <!-- We will update this via JavaScript after parsing -->
        </div>
    </div>

    <script>
        // Subscribe to the "ready" event which fires when widget is loaded
        JFCustomWidget.subscribe("ready", function() {
            // Fetch the JSON string from a user-defined parameter named "jsonResponse"
            var jsonResponse = JFCustomWidget.getWidgetSetting("jsonResponse");

            // Initialize placeholders
            var parsedCost = "";
            var parsedAddress = "";

            // Attempt to parse the JSON string
            try {
                // jsonResponse should be something like:
                //
                var parsed = JSON.parse(jsonResponse);

                // Extract cost/address if present
                parsedCost = parsed.cost || "";
                parsedAddress = parsed.address || "";
            } catch (err) {
                console.error("Error parsing JSON response:", err);
            }

            // Display the parsed data
            var resultDiv = document.getElementById("parsedResult");
            resultDiv.innerHTML = 
                "<b>Cost:</b> " + parsedCost + "<br>" +
                "<b>Address:</b> " + parsedAddress;

            // Send the cost back to the form as the widget value
            // (You could also send the entire JSON string if desired.)
            JFCustomWidget.sendData({ value: parsedCost });
        });

        // When the form is submitted, we can send the same or modified data
        JFCustomWidget.subscribe("submit", function() {
            var costValue = document.getElementById("parsedResult").innerText || "";

            // We'll submit the entire text content or just the cost.
            // For demonstration, let's only pass the cost as the final "value".
            // You could also pass JSON with cost + address if you prefer.
            var msg = {
                valid: true,
                value: costValue
            };
            JFCustomWidget.sendSubmit(msg);
        });
    </script>
</body>
</html>
